<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>Payments — Surya Car Pool</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
	<style>
		body {
			background: linear-gradient(135deg, #f6d365 0%, #fda085 50%, #fbc2eb 100%);
			min-height: 100vh;
			font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
		}

		.glass {
			background: rgba(255, 255, 255, 0.85);
			backdrop-filter: blur(6px);
			border-radius: 18px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
			padding: 24px;
		}

		.hero {
			display: grid;
			grid-template-columns: 1fr 360px;
			gap: 24px;
			align-items: start;
		}

		.brand-badge {
			display: inline-flex;
			gap: 10px;
			align-items: center;
			padding: 6px 12px;
			background: linear-gradient(90deg, #ff7a7a, #ffd47a);
			border-radius: 999px;
			color: white;
			font-weight: 600;
			box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
		}

		.summary-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 12px;
		}

		.summary-item {
			background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.75));
			padding: 12px;
			border-radius: 10px;
			border: 1px solid rgba(0, 0, 0, 0.04);
		}

		.amount-pill {
			font-size: 1.35rem;
			font-weight: 700;
			padding: 10px 16px;
			border-radius: 999px;
			background: linear-gradient(90deg, #00c6ff, #0072ff);
			color: white;
			display: inline-block;
			box-shadow: 0 8px 24px rgba(0, 114, 255, 0.18);
		}

		.pay-methods .btn {
			border-radius: 999px;
			padding: 8px 18px;
			font-weight: 600;
		}

		.muted {
			color: #666;
			font-size: 0.94rem;
		}

		@media (max-width:900px) {
			.hero {
				grid-template-columns: 1fr;
			}

			.summary-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>

</head>

<body>
	<div class="container py-5">
		<div class="glass">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<div>
					<div class="brand-badge">
						<img th:src="@{/images/logo.png}" alt="Surya Car Pool"
							style="width:20px; height:20px; object-fit:contain;" />
						Surya Car Pool
					</div>
					<h2 class="mt-3 mb-0">Secure payment</h2>
					<p class="muted">Complete your booking — safe & fast.</p>
				</div>
				<div class="text-start">
					<small class="muted">Booking ID</small>
					<div id="bookingId" class="fw-bold" th:text="${booking.id}">
						—
					</div>
				</div>
			</div>

			<div class="hero">
				<div>
					<h5 class="mb-3">Booking summary</h5>

					<div class="summary-grid mb-3">

						<div class="summary-item">
							<div class="muted">Customer</div>
							<div class="fw-semibold" th:text="${booking.customerName}">Customer</div>
						</div>

						<div class="summary-item">
							<div class="muted">Email</div>
							<div class="fw-semibold" th:text="${booking.email}">Email</div>
						</div>

						<div class="summary-item">
							<div class="muted">Phone</div>
							<div class="fw-semibold" th:text="${booking.phone}">Phone</div>
						</div>

						<div class="summary-item">
							<div class="muted">Car ID</div>
							<div class="fw-semibold" th:text="${booking.carId}">Car</div>
						</div>

						<div class="summary-item">
							<div class="muted">Pickup</div>
							<div class="fw-semibold" th:text="${booking.pickupLocation}">Pickup</div>
						</div>

						<div class="summary-item">
							<div class="muted">Pickup date / time</div>
							<div class="fw-semibold"
								th:text="${booking.pickupDateTime != null ? booking.pickupDateTime : '—'}">
							</div>
						</div>

					</div>

					<div class="d-flex align-items-center justify-content-between mb-4">
						<div>
							<div class="muted">Amount to pay</div>
							<div class="amount-pill">
								₹ <span th:text="${booking.fixedDepositAmount}">0</span>
							</div>
						</div>
					</div>

					<form id="paymentForm" th:action="@{/payments/confirm}" method="post">
						<!-- Hidden inputs to help server-side binding if session not used -->
						<input type="hidden" name="customerName" id="inputCustomerName"
							th:value="${booking.customerName}" />
						<input type="hidden" name="email" id="inputEmail" th:value="${booking.email}" />
						<input type="hidden" name="phone" id="inputPhone" th:value="${booking.phone}" />
						<input type="hidden" name="carId" id="inputCarId" th:value="${booking.carId}" />
						<input type="hidden" name="pickupLocation" id="inputPickupLocation"
							th:value="${booking.pickupLocation}" />
						<input type="hidden" name="pickupDateTime" id="inputPickupDateTime"
							th:value="${booking.pickupDateTime}" />
						<input type="hidden" name="amount" id="inputAmount" th:value="${booking.amount}" />

						<div class="mb-3">
							<label class="form-label">Payment method</label>
							<div class="pay-methods d-flex gap-2 flex-wrap">
								<button type="button" data-method="CARD" class="btn btn-outline-primary">Card</button>
								<button type="button" data-method="UPI" class="btn btn-outline-success">UPI</button>
								<button type="button" data-method="NETBANKING"
									class="btn btn-outline-warning">Netbanking</button>
								<button type="button" data-method="CASH" class="btn btn-outline-secondary">Cash</button>
							</div>
							<input type="hidden" name="paymentMethod" id="paymentMethodInput" />

						</div>

						<div class="mb-3">
							<label for="notes" class="form-label">Notes (optional)</label>
							<textarea id="notes" name="notes" class="form-control" rows="2"
								th:text="${booking.notes}"></textarea>
						</div>

						<div class="d-flex gap-2">
							<button id="confirmBtn" type="submit" class="btn btn-primary btn-lg">Confirm & Pay</button>
						</div>
					</form>
				</div>

				<div>
					<div class="glass p-3">
						<h6 class="mb-2">Payment details</h6>
						<p class="muted small">We accept secure payments via card, UPI and netbanking. This page uses a
							mock flow — integrate your gateway to accept real payments.</p>

						<ul class="list-unstyled mt-3">
							<li class="mb-2"><strong>Secure</strong> — PCI-compliant payment partners</li>
							<li class="mb-2"><strong>Refunds</strong> — Easy refunds within 7 days</li>
							<li class="mb-2"><strong>Support</strong> — support@surya-car-pool.example</li>
						</ul>

						<div class="mt-4">
							<img src="https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=600&q=60"
								alt="car" class="img-fluid rounded" style="max-height:200px; object-fit:cover;" />
						</div>

						<div class="mt-4 text-center">
							<small class="muted">Powered by</small>
							<div class="fw-bold">Surya Payments</div>
						</div>
					</div>
				</div>
			</div> <!-- hero -->
		</div> <!-- glass -->
	</div> <!-- container -->

	<script>
		// Utility: format ISO date/time to readable
		function formatDateTime(iso) {
			if (!iso) return '—';
			try {
				const d = new Date(iso);
				return d.toLocaleString(undefined, {dateStyle: 'medium', timeStyle: 'short'});
			} catch (e) {return iso;}
		}

		// Try to fetch booking data from backend endpoint and populate the UI and hidden inputs.
		// Endpoint used: /api/bookings/current (GET) -> returns JSON:
		// { bookingId, customerName, email, phone, carId, pickupLocation, pickupDateTime, amount, notes }
		async function loadBooking() {
			const fallback = {
				bookingId: /*[[${booking.id}]]*/ '[[${booking.id}]]',
				customerName: document.getElementById('customerName').innerText.trim(),
				email: document.getElementById('email').innerText.trim(),
				phone: document.getElementById('phone').innerText.trim(),
				carId: document.getElementById('carId').innerText.trim(),
				pickupLocation: document.getElementById('pickupLocation').innerText.trim(),
				pickupDateTime: document.getElementById('pickupDateTime').innerText.trim(),
				amount: document.getElementById('amount').innerText.replace(/[^\d.-]/g, '').trim()
			};

			try {
				const resp = await fetch('/api/bookings/current', {cache: 'no-store'});
				if (!resp.ok) throw new Error('no booking');
				const b = await resp.json();
				// populate UI
				if (b.bookingId || b.id) {
					document.getElementById('bookingId').innerText = b.bookingId || b.id;
				}
				document.getElementById('customerName').innerText = b.customerName || fallback.customerName || '—';
				document.getElementById('email').innerText = b.email || fallback.email || '—';
				document.getElementById('phone').innerText = b.phone || fallback.phone || '—';
				document.getElementById('carId').innerText = b.carId || fallback.carId || '—';
				document.getElementById('pickupLocation').innerText = b.pickupLocation || fallback.pickupLocation || '—';
				document.getElementById('pickupDateTime').innerText = formatDateTime(b.pickupDateTime || fallback.pickupDateTime);
				document.getElementById('amount').innerText = (b.amount != null) ? '₹ ' + Number(b.amount).toFixed(2) : (fallback.amount ? '₹ ' + fallback.amount : '₹ —');

				// set hidden inputs for server-side binding when form posts
				document.getElementById('inputCustomerName').value = b.customerName || '';
				document.getElementById('inputEmail').value = b.email || '';
				document.getElementById('inputPhone').value = b.phone || '';
				document.getElementById('inputCarId').value = b.carId || '';
				document.getElementById('inputPickupLocation').value = b.pickupLocation || '';
				document.getElementById('inputPickupDateTime').value = b.pickupDateTime || '';
				document.getElementById('inputAmount').value = (b.amount != null) ? b.amount : '';

			} catch (err) {
				// fallback: don't break — leave Thymeleaf-rendered values (if any)
				console.warn('Could not load booking from /api/bookings/current, using fallback.', err);
			}
		}

		// Payment method selection handler
		document.addEventListener('click', (e) => {
			const btn = e.target.closest('[data-method]');
			if (!btn) return;
			document.querySelectorAll('.pay-methods .btn').forEach(b => b.classList.remove('btn-primary'));
			btn.classList.add('btn-primary');
			const method = btn.getAttribute('data-method');
			document.getElementById('paymentMethodInput').value = method;
		});

		// On load
		loadBooking();
	</script>
	<script>
		// Validate payment method before form submit
		document.getElementById('paymentForm').addEventListener('submit', function (e) {
			const paymentMethod = document.getElementById('paymentMethodInput').value;

			if (!paymentMethod) {
				e.preventDefault(); // stop form submit
				alert('Please select a payment method to continue.');
				return false;
			}

			// disable button to avoid double submit
			// Initially disable Confirm button
			document.getElementById('confirmBtn').disabled = true;

			// Enable Confirm when payment method selected
			document.addEventListener('click', (e) => {
				const btn = e.target.closest('[data-method]');
				if (!btn) return;

				document.getElementById('confirmBtn').disabled = false;
			});
		});
	</script>

</body>

</html>