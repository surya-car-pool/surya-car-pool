<!-- html -->
<!-- File: surya-car-pool/src/main/resources/templates/payments.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>Payments — Surya Car Pool</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
	<style>
		body {
			background: linear-gradient(135deg, #f6d365 0%, #fda085 50%, #fbc2eb 100%);
			min-height: 100vh;
			font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
		}

		.glass {
			background: rgba(255, 255, 255, 0.85);
			backdrop-filter: blur(6px);
			border-radius: 18px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
			padding: 24px;
		}

		.hero {
			display: grid;
			grid-template-columns: 1fr 360px;
			gap: 24px;
			align-items: start;
		}

		.brand-badge {
			display: inline-flex;
			gap: 10px;
			align-items: center;
			padding: 6px 12px;
			background: linear-gradient(90deg, #ff7a7a, #ffd47a);
			border-radius: 999px;
			color: white;
			font-weight: 600;
			box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
		}

		.summary-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 12px;
		}

		.summary-item {
			background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.75));
			padding: 12px;
			border-radius: 10px;
			border: 1px solid rgba(0, 0, 0, 0.04);
		}

		.amount-pill {
			font-size: 1.35rem;
			font-weight: 700;
			padding: 10px 16px;
			border-radius: 999px;
			background: linear-gradient(90deg, #00c6ff, #0072ff);
			color: white;
			display: inline-block;
			box-shadow: 0 8px 24px rgba(0, 114, 255, 0.18);
		}

		.pay-methods .btn {
			border-radius: 999px;
			padding: 8px 18px;
			font-weight: 600;
		}

		.muted {
			color: #666;
			font-size: 0.94rem;
		}

		@media (max-width:900px) {
			.hero {
				grid-template-columns: 1fr;
			}

			.summary-grid {
				grid-template-columns: 1fr;
			}
		}

		.navbar-custom {
			background: rgba(15, 23, 42, 0.95);
			backdrop-filter: blur(8px);
		}

		.nav-link i {
			color: rgb(255, 128, 64);
			margin-right: 4px;
		}

		/* Navbar icons - copied from Bookings page */
		.nav-link i {
			color: rgb(255, 128, 64);
			margin-right: 4px;
		}
		
	</style>

</head>

<body>
	<!-- NAVBAR (unchanged) -->
	<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
		<div class="container">
			<a class="navbar-brand d-flex align-items-center brand-logo" href="/home" aria-label="Surya Car Pool home">
				<img src="/images/logo.png" alt="Surya Car Pool"
					style="width:70px; height:70px; border-radius:14px; object-fit:contain;" />
				<div class="d-flex flex-column ms-2">
					<span class="brand-title text-white">Surya Car Pool</span>
					<span class="brand-tagline text-white-50">Self Drive Cars Provider</span>
				</div>
				<span class="ms-3 badge bg-white text-dark align-self-start" style="font-weight:600">Trusted</span>
			</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navMain">
				<ul class="navbar-nav ms-auto mb-2 mb-lg-0">
					<li class="nav-item"><a class="nav-link" href="/home"><i class="bi bi-house-door-fill"></i> Home</a>
					</li>
					<li class="nav-item"><a class="nav-link" href="/users/ui"><i class="bi bi-people-fill"></i>
							Users</a></li>
					<li class="nav-item"><a class="nav-link" href="/rides/ui"><i class="bi bi-car-front-fill"></i>
							Rides</a></li>
					<li class="nav-item"><a class="nav-link" href="/bookings/ui"><i class="bi bi-journal-check"></i>
							Bookings</a></li>
					<li class="nav-item"><a class="nav-link" href="/aboutus/ui"><i class="bi bi-info-circle-fill"></i>
							About Us</a></li>
					<li class="nav-item"><a class="nav-link" href="/contactus/ui"><i class="bi bi-envelope-fill"></i>
							Contact Us</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container py-5">
		<div class="glass">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<div>
					<div class="brand-badge">
						<img th:src="@{/images/logo.png}" alt="Surya Car Pool"
							style="width:20px; height:20px; object-fit:contain;" />
						Surya Car Pool
					</div>
					<h2 class="mt-3 mb-0">Secure payment</h2>
					<p class="muted">Complete your booking — safe & fast.</p>
				</div>
				<div class="text-start">
					<small class="muted">Booking ID</small>
					<div id="bookingId" class="fw-bold" th:text="${booking.id}">—</div>
				</div>
			</div>

			<div class="hero">
				<div>
					<h5 class="mb-3">Booking summary</h5>

					<div class="summary-grid mb-3">
						<div class="summary-item">
							<div class="muted">Customer</div>
							<div id="customerName" class="fw-semibold" th:text="${booking.customerName}">Customer</div>
						</div>

						<div class="summary-item">
							<div class="muted">Email</div>
							<div id="email" class="fw-semibold" th:text="${booking.email}">Email</div>
						</div>

						<div class="summary-item">
							<div class="muted">Phone</div>
							<div id="phone" class="fw-semibold" th:text="${booking.phone}">Phone</div>
						</div>

						<div class="summary-item">
							<div class="muted">Car ID</div>
							<div id="carId" class="fw-semibold" th:text="${booking.carId}">Car</div>
						</div>

						<div class="summary-item">
							<div class="muted">Pickup</div>
							<div id="pickupLocation" class="fw-semibold" th:text="${booking.pickupLocation}">Pickup
							</div>
						</div>

						<div class="summary-item">
							<div class="muted">Pickup date / time</div>
							<div id="pickupDateTime" class="fw-semibold"
								th:text="${booking.pickupDateTime != null ? booking.pickupDateTime : '—'}"></div>
						</div>
					</div>

					<div class="d-flex align-items-center justify-content-between mb-4">
						<div>
							<div class="muted">Amount to pay</div>
							<div class="amount-pill">₹ <span id="amount"
									th:text="${booking.fixedDepositAmount}">0</span></div>
						</div>
					</div>

					<form id="paymentForm" th:action="@{/payments/confirm}" method="post">
						<!-- Hidden inputs -->
						<input type="hidden" name="customerName" id="inputCustomerName"
							th:value="${booking.customerName}" />
						<input type="hidden" name="email" id="inputEmail" th:value="${booking.email}" />
						<input type="hidden" name="phone" id="inputPhone" th:value="${booking.phone}" />
						<input type="hidden" name="carId" id="inputCarId" th:value="${booking.carId}" />
						<input type="hidden" name="pickupLocation" id="inputPickupLocation"
							th:value="${booking.pickupLocation != null ? booking.pickupLocation : 'N/A'}" />
						<input type="hidden" name="pickupDateTime" id="inputPickupDateTime"
							th:value="${booking.pickupDateTime}" />
						<input type="hidden" name="amount" id="inputAmount" th:value="${booking.fixedDepositAmount}" />
						<input type="hidden" name="paymentMethod" id="paymentMethodInput" />

						<div class="mb-3">
							<label class="form-label">Payment method</label>
							<div class="pay-methods d-flex gap-2 flex-wrap">
								<button type="button" class="btn btn-outline-success" data-method="UPI">UPI</button>
								<button type="button" class="btn btn-outline-primary" data-method="CARD">Card</button>
								<button type="button" class="btn btn-outline-secondary" data-method="CASH">Cash</button>

								<button id="confirmBtn" type="submit" class="btn btn-primary btn-lg" disabled>Confirm &
									Pay</button>
							</div>
						</div>

						<div class="mb-3">
							<label for="notes" class="form-label">Notes (optional)</label>
							<textarea id="notes" name="notes" class="form-control" rows="2"
								th:text="${booking.notes}"></textarea>
						</div>
					</form>
				</div>

				<div>
					<div class="glass p-3">
						<h6 class="mb-2">Payment details</h6>
						<p class="muted small">We accept secure payments via card, UPI and netbanking. This page uses a
							mock flow — integrate your gateway to accept real payments.</p>
						<ul class="list-unstyled mt-3">
							<li class="mb-2"><strong>Secure</strong> — PCI-compliant payment partners</li>
							<li class="mb-2"><strong>Refunds</strong> — Easy refunds within 7 days</li>
							<li class="mb-2"><strong>Support</strong> — support@suryacarpool.com</li>
						</ul>
						<div class="mt-4">
							<img src="https://images.unsplash.com/photo-1542362567-b07e54358753?auto=format&fit=crop&w=600&q=60"
								alt="car" class="img-fluid rounded" style="max-height:200px; object-fit:cover;" />
						</div>
						<div class="mt-4 text-center">
							<small class="muted">Powered by</small>
							<div class="fw-bold">Surya's Payments</div>
						</div>
					</div>
				</div>
			</div> <!-- hero -->
		</div> <!-- glass -->
	</div> <!-- container -->

	<!-- UPI Modal -->
	<div class="modal fade" id="upiModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Pay with UPI</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body text-center">
					<p class="muted">Scan the QR with your UPI app and complete payment.</p>
					<img id="upiQrImg" width="220" alt="UPI QR" />
					<div id="upiStatus" class="mt-3 small text-success d-none">Waiting for confirmation...</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="upiPaidBtn" class="btn btn-success">I have paid</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Card Modal -->
	<div class="modal fade" id="cardModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Card Payment</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="cardForm" class="row g-2">
						<div class="col-12">
							<label class="form-label">Name on card</label>
							<input class="form-control" id="cardName" required />
						</div>
						<div class="col-12">
							<label class="form-label">Card number</label>
							<input class="form-control" id="cardNumber" inputmode="numeric" pattern="\d{12,19}"
								required />
						</div>
						<div class="col-6">
							<label class="form-label">Expiry (MM/YY)</label>
							<input class="form-control" id="cardExpiry" placeholder="MM/YY" required />
						</div>
						<div class="col-6">
							<label class="form-label">CVV</label>
							<input class="form-control" id="cardCvv" inputmode="numeric" pattern="\d{3,4}" required />
						</div>
						<div class="col-12">
							<div class="text-muted small">Amount: ₹ <span id="cardAmountDisplay"></span></div>
						</div>
					</form>
					<div id="cardError" class="text-danger small mt-2 d-none"></div>
				</div>
				<div class="modal-footer">
					<button type="button" id="cardPayBtn" class="btn btn-primary">Pay</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<!-- footer unchanged -->
	<footer class="bg-dark text-light mt-5">
		<div class="container py-4 text-center small" style="color: brown;">© Surya Car Pool -2025 · All rights reserved
		</div>
		<div class="text-center text-muted small py-2" style="background:rgba(0,0,0,0.04)">Need help? Email <a
				href="mailto:support@suryacarpool.example" class="text-muted">support@suryacarpool.example</a> · Terms
			apply</div>
	</footer>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// currentPaymentId holds the payment initiated by backend
		let currentPaymentId = null;
		const upiModal = new bootstrap.Modal(document.getElementById('upiModal'));
		const cardModal = new bootstrap.Modal(document.getElementById('cardModal'));

		// UI: payment method selection & enabling confirm button
		document.addEventListener('click', (e) => {
			const btn = e.target.closest('[data-method]');
			if (!btn) return;
			document.querySelectorAll('.pay-methods .btn').forEach(b => b.classList.remove('btn-primary'));
			btn.classList.add('btn-primary');
			const method = btn.getAttribute('data-method');
			document.getElementById('paymentMethodInput').value = method;
			document.getElementById('confirmBtn').disabled = false;
		});

		// Initiate payment on the server; returns object { paymentId, upiQr, ... }
		async function initiatePaymentIfNeeded(method) {
			// If already initiated for same method, reuse
			if (currentPaymentId) return currentPaymentId;
			const payload = {
				customerName: document.getElementById("inputCustomerName").value,
				email: document.getElementById("inputEmail").value,
				phone: document.getElementById("inputPhone").value,
				carId: document.getElementById("inputCarId").value,
				pickupLocation: document.getElementById("inputPickupLocation").value,
				amount: document.getElementById("inputAmount").value,
				paymentMethod: method
			};
			try {
				const res = await fetch("/api/payments/initiate", {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify(payload)
				});
				if (!res.ok) throw new Error('initiate failed');
				const data = await res.json();
				currentPaymentId = data.paymentId;
				return data;
			} catch (err) {
				console.error('initiate failed', err);
				throw err;
			}
		}

		// Intercept form submit to show modal or perform flow
		document.getElementById('paymentForm').addEventListener('submit', async function (e) {
			e.preventDefault();
			const method = document.getElementById('paymentMethodInput').value;
			if (!method) {
				alert('Please select a payment method to continue.');
				return;
			}

			// CASH: just submit the form (server can mark as paid or handle offline)
			if (method === 'CASH') {
				// optionally set a flag before submitting
				this.submit();
				return;
			}

			// For UPI and CARD: ensure initiation then open modal
			try {
				const data = await initiatePaymentIfNeeded(method);
				if (method === 'UPI') {
					// show QR in modal and open
					if (data && data.upiQr) {
						document.getElementById("upiQrImg").src =
							"https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(data.upiQr);
					}
					document.getElementById('upiStatus').classList.add('d-none');
					upiModal.show();
					return;
				}

				if (method === 'CARD') {
					// populate amount display and open modal
					const amount = document.getElementById('inputAmount').value || document.getElementById('amount').innerText || '0';
					document.getElementById('cardAmountDisplay').innerText = amount;
					// reset card form
					document.getElementById('cardForm').reset();
					document.getElementById('cardError').classList.add('d-none');
					cardModal.show();
					return;
				}
			} catch (err) {
				alert('Could not initiate payment. Try again.');
			}
		});

		// UPI: user clicks "I have paid" -> verify then submit
		document.getElementById('upiPaidBtn').addEventListener('click', async () => {
			if (!currentPaymentId) {
				alert('Payment not initiated. Try again.');
				return;
			}
			document.getElementById('upiStatus').classList.remove('d-none');
			try {
				await fetch(`/api/payments/verify?paymentId=${encodeURIComponent(currentPaymentId)}&success=true`, {method: 'POST'});
				upiModal.hide();
				// submit final server form to record booking/payment
				document.getElementById('paymentForm').submit();
			} catch (err) {
				console.error(err);
				alert('Could not verify UPI payment. Try again.');
			}
		});

		// Card: simulate charge endpoint, verify, then submit
		document.getElementById('cardPayBtn').addEventListener('click', async () => {
			const name = document.getElementById('cardName').value.trim();
			const number = document.getElementById('cardNumber').value.replace(/\s+/g, '');
			const expiry = document.getElementById('cardExpiry').value.trim();
			const cvv = document.getElementById('cardCvv').value.trim();
			const errEl = document.getElementById('cardError');

			// basic validation
			if (!name || number.length < 12 || !expiry || cvv.length < 3) {
				errEl.innerText = 'Please enter valid card details.';
				errEl.classList.remove('d-none');
				return;
			}
			errEl.classList.add('d-none');

			// ensure initiation exists
			if (!currentPaymentId) {
				try {
					await initiatePaymentIfNeeded('CARD');
				} catch (err) {
					alert('Could not initiate card payment. Try again.');
					return;
				}
			}

			// mock charge request
			try {
				const payload = {
					paymentId: currentPaymentId,
					card: {name, number, expiry, cvv},
					amount: document.getElementById('inputAmount').value
				};

				const res = await fetch('/api/payments/charge', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(payload)
				});
				if (!res.ok) throw new Error('charge failed');
				const result = await res.json();
				// assume success flag in result.success
				if (result.success) {
					// verify with server (mock)
					await fetch(`/api/payments/verify?paymentId=${encodeURIComponent(currentPaymentId)}&success=true`, {method: 'POST'});
					cardModal.hide();
					document.getElementById('paymentForm').submit();
				} else {
					throw new Error(result.message || 'card declined');
				}
			} catch (err) {
				errEl.innerText = 'Card payment failed. Try different card or try again.';
				errEl.classList.remove('d-none');
				console.error('Card charge failed', err);
			}
		});

		// Try to fetch booking data and populate UI and hidden inputs.
		async function loadBooking() {
			// keep a small fallback reading from the server-side rendered values
			const fallback = {
				bookingId: document.getElementById('bookingId') ? document.getElementById('bookingId').innerText.trim() : '',
				customerName: document.getElementById('customerName') ? document.getElementById('customerName').innerText.trim() : '',
				email: document.getElementById('email') ? document.getElementById('email').innerText.trim() : '',
				phone: document.getElementById('phone') ? document.getElementById('phone').innerText.trim() : '',
				carId: document.getElementById('carId') ? document.getElementById('carId').innerText.trim() : '',
				pickupLocation: document.getElementById('pickupLocation') ? document.getElementById('pickupLocation').innerText.trim() : '',
				pickupDateTime: document.getElementById('pickupDateTime') ? document.getElementById('pickupDateTime').innerText.trim() : '',
				amount: document.getElementById('amount') ? document.getElementById('amount').innerText.replace(/[^\d.-]/g, '').trim() : ''
			};
			try {
				const resp = await fetch('/api/bookings/current', {cache: 'no-store'});
				if (!resp.ok) throw new Error('no booking');
				const b = await resp.json();
				if (b.bookingId || b.id) document.getElementById('bookingId').innerText = b.bookingId || b.id;
				document.getElementById('customerName').innerText = b.customerName || fallback.customerName || '—';
				document.getElementById('email').innerText = b.email || fallback.email || '—';
				document.getElementById('phone').innerText = b.phone || fallback.phone || '—';
				document.getElementById('carId').innerText = b.carId || fallback.carId || '—';
				document.getElementById('pickupLocation').innerText = b.pickupLocation || fallback.pickupLocation || '—';
				document.getElementById('pickupDateTime').innerText = b.pickupDateTime ? new Date(b.pickupDateTime).toLocaleString() : fallback.pickupDateTime || '—';
				document.getElementById('amount').innerText = (b.amount != null) ? Number(b.amount).toFixed(2) : (fallback.amount ? fallback.amount : '0');
				document.getElementById('inputCustomerName').value = b.customerName || '';
				document.getElementById('inputEmail').value = b.email || '';
				document.getElementById('inputPhone').value = b.phone || '';
				document.getElementById('inputCarId').value = b.carId || '';
				document.getElementById('inputPickupLocation').value = b.pickupLocation || '';
				document.getElementById('inputPickupDateTime').value = b.pickupDateTime || '';
				document.getElementById('inputAmount').value = (b.amount != null) ? b.amount : '';
			} catch (err) {
				console.warn('Could not load booking from /api/bookings/current, using fallback.', err);
			}
		}

		// On page load
		loadBooking();
	</script>
</body>

</html>