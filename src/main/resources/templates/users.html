<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Users - Surya Car Pool</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

	<style>
		body {
			min-height: 100vh;
			background: linear-gradient(135deg,
					#ffecd2,
					#fcb69f,
					#a1c4fd,
					#c2e9fb,
					#d4fc79);
			background-attachment: fixed;
		}

		.navbar-custom {
			background: rgba(15, 23, 42, 0.95);
		}

		.table thead th {
			background: linear-gradient(135deg, #0d6efd, #3b8bff);
			color: #fff;
			text-align: center;
		}

		.table tbody td {
			text-align: center;
			vertical-align: middle;
		}
	</style>
</head>

<body>
	<!-- NAVBAR -->
	<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
		<div class="container">
			<a class="navbar-brand d-flex align-items-center brand-logo" href="/home" aria-label="Surya Car Pool home">
				<svg class="brand-svg" viewBox="0 0 64 64" xmlns="/images/logo.png" role="img"
					aria-labelledby="logoTitle logoDesc">
					<title id="logoTitle">Surya Car Pool logo</title>
					<desc id="logoDesc">Sun rising above a road — Surya Car Pool</desc>
					<img src="/images/logo.png" alt="Surya Car Pool"
						style="width:70px; height:70px; border-radius:14px; object-fit:contain;" />
					<rect width="64" height="64" rx="10" fill="url(#g1)" />
					<circle cx="20" cy="18" r="8" fill="#fff5d6" />
					<path d="M6 44 C18 38,46 38,58 44 L58 50 C46 44,18 44,6 50 Z" fill="#0f1724" />
					<g stroke="#ffd166" stroke-width="1.8" stroke-linecap="round">
						<path d="M12 43 L16 43" stroke-dasharray="4 3" />
						<path d="M24 42 L28 42" stroke-dasharray="4 3" />
						<path d="M36 42 L40 42" stroke-dasharray="4 3" />
						<path d="M48 43 L52 43" stroke-dasharray="4 3" />
					</g>
					<path d="M18 36 h10 l3-5 h8 l3 5 h3 v3 h-30 v-3 z" fill="#fff" />
				</svg>

				<div class="d-flex flex-column ms-2">
					<span class="brand-title text-white">Surya Car Pool</span>
					<span class="brand-tagline text-white-50">Self Drive Cars Provider</span>
				</div>

				<span class="ms-3 badge bg-white text-dark align-self-start" style="font-weight:600">Trusted</span>
			</a>

			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navMain">
				<ul class="navbar-nav ms-auto mb-2 mb-lg-0">
					<li class="nav-item">
						<a class="nav-link" href="/home">
							<i class="bi bi-house-door-fill"></i> Home
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link" href="/users/ui">
							<i class="bi bi-people-fill"></i> Users
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link" href="/rides/ui">
							<i class="bi bi-car-front-fill"></i> Rides
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link active" aria-current="page" href="/bookings/ui">
							<i class="bi bi-journal-check"></i> Bookings / Book a Car
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link" href="/aboutus/ui">
							<i class="bi bi-info-circle-fill"></i> About Us
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link" href="/contactus/ui">
							<i class="bi bi-envelope-fill"></i> Contact Us
						</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container py-4">

		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3>Owners & Cars</h3>
			<a href="/createuser/ui" class="btn btn-primary">
				<i class="bi bi-plus-circle"></i> Create New Owner
			</a>
		</div>

		<div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<strong>Existing Owners</strong>
				<button class="btn btn-sm btn-outline-secondary" id="refreshUsersBtn">
					<i class="bi bi-arrow-clockwise"></i> Refresh
				</button>
			</div>

			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-hover mb-0">
						<thead>
							<tr>
								<th>ID</th>
								<th>Owner</th>
								<th>Phone</th>
								<th>Email</th>
								<th>Car(s)</th>
								<th>Reg No(s)</th>
								<th>Seat(s)</th>
								<th>Status</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody id="usersTableBody">
							<!-- JS fills this -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		/* =========================
		   SINGLE SOURCE OF TRUTH
		   ========================= */

		function getUserIdFromUrl() {
			return new URLSearchParams(window.location.search).get('id');
		}

		async function loadUsers() {
			const tbody = document.getElementById('usersTableBody');
			tbody.innerHTML = '';

			try {
				const userId = getUserIdFromUrl();
				const url = userId ? `/api/users/${userId}` : '/api/users';

				const response = await fetch(url);
				if (!response.ok) {
					throw new Error('Failed to load users');
				}

				let data = await response.json();
				const users = Array.isArray(data) ? data : [data];

				if (users.length === 0) {
					tbody.innerHTML = `
						<tr>
							<td colspan="9" class="text-center text-muted py-3">
								No users found
							</td>
						</tr>`;
					return;
				}

				users.forEach(u => {
					const cars = Array.isArray(u.cars) ? u.cars : [];

					const carNames = cars.map(c => `${c.make || ''} ${c.model || ''}`.trim()).join('<br>') || '-';
					const regNos = cars.map(c => c.registrationNo || '-').join('<br>') || '-';
					const seats = cars.map(c => c.seats ?? '-').join(', ') || '-';

					const tr = document.createElement('tr');
					tr.innerHTML = `
						<td>${u.id}</td>
						<td>${u.name || '-'}</td>
						<td>${u.phone || '-'}</td>
						<td>${u.email || '-'}</td>
						<td>${carNames}</td>
						<td>${regNos}</td>
						<td>${seats}</td>
						<td>${u.enabled ? 'Active' : 'Disabled'}</td>
						<td>
							<button class="btn btn-sm btn-outline-danger"
								onclick="deleteUser(${u.id})">
								<i class="bi bi-trash"></i>
							</button>
						</td>
					`;
					tbody.appendChild(tr);
				});

			} catch (e) {
				console.error(e);
				tbody.innerHTML = `
					<tr>
						<td colspan="9" class="text-center text-danger py-3">
							Error loading users
						</td>
					</tr>`;
			}
		}

		async function deleteUser(id) {
			if (!confirm(`Delete user ${id}?`)) return;

			await fetch(`/api/users/${id}`, {method: 'DELETE'});
			loadUsers();
		}

		document.getElementById('refreshUsersBtn').addEventListener('click', loadUsers);
		loadUsers();
	</script>

	<footer class="bg-dark text-light mt-5">
		<div class="container py-3 text-center small">
			© Surya Car Pool - 2025
		</div>
	</footer>

</body>

</html>